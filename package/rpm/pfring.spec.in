Summary: PF_RING user-space tools
Name: pfring
Version: @VERS@
Release: %{buildrev}
License: GPL
Group: Networking/Utilities
URL: http://www.ntop.org/products/pf_ring/
Packager: Luca Deri <deri@ntop.org>
# Temporary location where the RPM will be built
BuildRoot:  %{_tmppath}/%{name}-%{version}-root
Requires: pfring-dkms = @VERS@, net-tools
# Disable shared libs dependency check (needed by FPGA libs)
AutoReq: no
# 
# As dependecies are disabled (AutoReqProv: no) we must report them manually
Provides: daq_pfring_zc.so, daq_pfring.so, libpfring.so

%description
PF_RING kernel module and drivers for high-speed RX/TX package processing
GIT info: @GIT_BRANCH@:@GIT_HASH@

%package devel
Summary: PF_RING kernel developement library and include files
Group: Development/Libraries
Requires: %{name} = %{version}-%{release}

%description devel
PF_RING kernel module and drivers include files for high-speed RX/TX package processing

%install
PATH=/usr/bin:/bin:/usr/sbin:/sbin
if [ -d %{buildroot} ]; then
        \rm -rf %{buildroot}
fi

mkdir -p %{buildroot}%{_defaultdocdir}/%{name}-%{version}
mkdir -p %{buildroot}%{_includedir}/linux
mkdir -p %{buildroot}%{_sysconfdir}/init.d
mkdir -p %{buildroot}%{_sysconfdir}/init
mkdir -p %{buildroot}%{_bindir}
mkdir -p %{buildroot}%{_libdir}
mkdir -p %{buildroot}%{_libdir}/daq

# Kernel module
#cp %{pfring_path}/kernel/pf_ring.ko %{buildroot}%{_prefix}/pfring/kernel
cp %{pfring_path}/kernel/linux/pf_ring.h %{buildroot}%{_includedir}/linux/
# Userland
cp %{pfring_path}/README.FIRST                  %{buildroot}%{_defaultdocdir}/%{name}-%{version}
cp %{pfring_path}/userland/snort/pfring-daq-module/README.1st %{buildroot}%{_defaultdocdir}/%{name}-%{version}/README-DAQ.1st
cp %{pfring_path}/userland/lib/libpfring.a      %{buildroot}%{_libdir}
cp %{pfring_path}/userland/lib/libpfring.so     %{buildroot}%{_libdir}

# Don't think it is a good idea to deploy libpcap within the same pfring package
#cp %{pfring_path}/userland/libpcap/libpcap.a    %{buildroot}%{_libdir}
#cp %{pfring_path}/userland/libpcap/libpcap.so.1.7.4    %{buildroot}%{_libdir}

cp %{pfring_path}/userland/lib/pfring.h         %{buildroot}%{_includedir}
cp %{pfring_path}/userland/lib/pfring_zc.h      %{buildroot}%{_includedir}

#cp %{pfring_path}/userland/tcpdump/tcpdump      %{buildroot}%{_prefix}/bin
cp %{pfring_path}/userland/examples/pfcount     %{buildroot}%{_bindir}
cp %{pfring_path}/userland/examples/pfdump      %{buildroot}%{_bindir}
cp %{pfring_path}/userland/examples/pfsend      %{buildroot}%{_bindir}

cp %{pfring_path}/package/etc/init.d/pf_ring    %{buildroot}%{_sysconfdir}/init.d
cp %{pfring_path}/package/etc/init.d/cluster    %{buildroot}%{_sysconfdir}/init.d
cp %{pfring_path}/package/etc/init/pf_ring.conf %{buildroot}%{_sysconfdir}/init
@ACCOLADE_LIB_COPY@
@NAPATECH_LIB_COPY@
@MYRICOM_LIB_COPY@
# DAQ
cp %{pfring_path}/userland/snort/pfring-daq-module/daq_pfring.la %{buildroot}%{_libdir}/daq
cp %{pfring_path}/userland/snort/pfring-daq-module/.libs/daq_pfring.so %{buildroot}%{_libdir}/daq
cp %{pfring_path}/userland/snort/pfring-daq-module-zc/daq_pfring_zc.la %{buildroot}%{_libdir}/daq
cp %{pfring_path}/userland/snort/pfring-daq-module-zc/.libs/daq_pfring_zc.so %{buildroot}%{_libdir}/daq
#cp -a $HOME/daq-2.?.?/sfbpf/.libs/libsfbpf.so.0 $HOME/daq-2.?.?/sfbpf/.libs/libsfbpf.so.0.0.1 %{buildroot}%{_prefix}/lib
%if %nozc == 0
cp %{pfring_path}/userland/examples_zc/zbalance_ipc %{buildroot}%{_bindir}
cp %{pfring_path}/userland/examples_zc/zsend %{buildroot}%{_bindir}
cp %{pfring_path}/userland/examples_zc/zcount %{buildroot}%{_bindir}
cp %{pfring_path}/userland/examples_zc/zcount_ipc %{buildroot}%{_bindir}
%endif


# Clean out our build directory
%clean
rm -fr %{buildroot}

%files
# Set the default attributes of all of the files specified to have an
# owner and group of root and to inherit the permissions of the file
# itself.
%defattr(-,root,root,-)
%{_libdir}/*.so
%{_libdir}/daq/*.so
%{_bindir}/pfcount
%{_bindir}/pfdump
%{_bindir}/pfsend
%if %nozc == 0
%{_bindir}/zbalance_ipc
%{_bindir}/zsend
%{_bindir}/zcount
%{_bindir}/zcount_ipc
%endif
%{_sysconfdir}/init/pf_ring.conf
%{_sysconfdir}/init.d/pf_ring
%{_sysconfdir}/init.d/cluster

@ACCOLADE_LIBS@
@NAPATECH_LIBS@
@MYRICOM_LIBS@

%files devel
%{_includedir}/*.h
%{_includedir}/linux/*.h
%{_libdir}/*.a
%{_libdir}/daq/*.la
%{_defaultdocdir}/%{name}-%{version}/README.FIRST
%{_defaultdocdir}/%{name}-%{version}/README-DAQ.1st

%post
/sbin/chkconfig pf_ring on > /dev/null 2>&1
/sbin/chkconfig cluster on > /dev/null 2>&1
if [ -f /opt/napatech3/lib/libntapi.so ]; then cp /opt/napatech3/lib/libntapi.so /lib64; fi
if [ -f /opt/napatech3/lib/libntos.so ];  then cp /opt/napatech3/lib/libntos.so /lib64;  fi
if [ -f /opt/accolade/lib/libanic.so ];   then cp /opt/accolade/lib/libanic.so /lib64;   fi
if [ -f /opt/snf/lib/libsnf.so ];         then cp /opt/snf/lib/libsnf.so /lib64; ln -s /lib64/libsnf.so /lib64/libsnf.so.0; fi
/sbin/ldconfig > /dev/null 2>&1
 
%changelog
* Wed Dec  5 2012  <deri@centos.ntop.org> - @VERS@-%{buildrev}
- 

* Sat Mar 10 2012 Luca Deri <deri@ntop.org>
- Original upstream version



